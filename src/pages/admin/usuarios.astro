---
import Layout_admin from "../../layouts/Layout_admin.astro";
import SectionContainer from "../../components/admin/SectionContainer.astro";
import Aside from "../../components/admin/Aside.astro";
import Header from "../../components/admin/Header.astro";

import { db, user, eq } from "astro:db";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();

  // Handle delete
  if (formData.get("action") === "delete") {
    const userId = formData.get("user_id");
    if (userId) {
      await db.delete(user).where(eq(user.user_id, parseInt(userId as string)));
    }
    return Astro.redirect("/admin/usuarios");
  }

  // Handle insert
  const name = formData.get("name");
  const email = formData.get("email");
  const phone = formData.get("phone");
  const address = formData.get("address");
  if (
    typeof name === "string" &&
    typeof email === "string" &&
    typeof phone === "string" &&
    typeof address === "string"
  ) {
    await db.insert(user).values({
      clerk_user_id: "temp_user_" + Date.now(),
      name,
      email,
      phone,
      address,
    });
  }
}

const users = await db.select().from(user);
---

<Layout_admin title="Usuarios - Agua MÃ¡xima">
  <Aside />
  <SectionContainer>
    <Header
      title="Usuarios"
      description="Gestiona los usuarios de la plataforma"
    />
    <h1>Usuarios</h1>
    <ul>
      {
        users.map((u) => (
          <li>
            {u.name} - {u.email} - {u.phone} - {u.address} - {u.clerk_user_id} -{" "}
            {u.user_id}
            <form method="post" style="display: inline;">
              <input type="hidden" name="action" value="delete" />
              <input type="hidden" name="user_id" value={u.user_id} />
              <button type="submit">Delete</button>
            </form>
          </li>
        ))
      }

      <form method="post">
        <label for="name">Name</label>
        <input type="text" name="name" id="name" />
        <label for="email">Email</label>
        <input type="email" name="email" id="email" />
        <label for="phone">Phone</label>
        <input type="tel" name="phone" id="phone" />
        <label for="address">Address</label>
        <input type="text" name="address" id="address" />
        <button type="submit">Insert</button>
      </form>
    </ul>
  </SectionContainer>
</Layout_admin>
